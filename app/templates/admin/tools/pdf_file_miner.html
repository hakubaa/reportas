{% extends "base.html" %}
{% import 'admin/tools/utils.html' as utils %}

{% block responsivnes %}{% endblock %}
{% block title %} Parser {% endblock %}

{% block head_css %}
    <link href="{{ url_for('static', filename='vendors/select2/css/select2.min.css') }}", rel="stylesheet">
    <link href="{{ url_for('static', filename='vendors/jquery-ui/jquery-ui.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendors/bootstrap-datepicker/css/bootstrap-datepicker3.min.css') }}", rel="stylesheet">
    <link href="{{ url_for('static', filename='vendors/bootstrap3-dialog/css/bootstrap-dialog.min.css') }}", rel="stylesheet">
    <link href="{{ url_for('static', filename='css/non-responsive.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/miner.css') }}" rel="stylesheet">
    <style>
        .backgroundAnimated{    
            background-image:none !important;
            -webkit-animation: fadeIt 3s ease-in-out; 
               -moz-animation: fadeIt 3s ease-in-out; 
                 -o-animation: fadeIt 3s ease-in-out; 
                    animation: fadeIt 3s ease-in-out; 
        }
    </style>
{% endblock %}

{% block page_body %}
{{ super() }}
    <div class="container container-full">
        <h3>Financial Data Miner - Summary</h3>
        <div>
            <p>Financial report for <strong><span class="timerange" id="report-timerange">{% if report.timerange %}{{report.timerange}}{% else %}(not identified){% endif %}</span></strong> months ended on <strong><span class="timestamp" id="report-timestamp">{% if report.timestamp %}{{report.timestamp.strftime('%Y-%m')}} {% else %}(not identified){% endif %}</span></strong> 
            (<a href="javascript:void(0);" class="time-editor-btn">Edit <span class="glyphicon glyphicon-edit"></span></a>).</p>
        </div>
        <div>
            <label>Company </label>
            <select id="company-select">
                <option disabled selected value> -- select a company -- </option>
                {% for comp in companies %}<option value="{{comp.id}}" {% if company and company.name == comp.name %}selected="selected"{% endif %}>{{comp.name}}</option>{% endfor %}
            </select>
        </div>

        <div id="report-wrapper">
            <div id="report-ui">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" checked id="layout-checkbox" onchange="switchLayout();"> Maintain the original physical layout of the text.
                    </label>
                </div>
                
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default" 
                            data-select-type="ALL" id="stm-filter-btn"
                            title="Statement">ALL</button>
                    <button type="button" class="btn btn-default dropdown-toggle" 
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                            title="Statement">
                        <span class="caret"></span>
                        <span class="sr-only">Toggle Dropdown</span>
                    </button>
                    <ul class="dropdown-menu" id="stm-filter-list">
                        <li><a data-select-type="ALL" href="#">ALL</a></li>
                        <li><a data-select-type="NONE" href="#">NONE</a></li>
                        <li><a data-select-type="BLS" href="#">BLS</a></li>
                        <li><a data-select-type="ICS" href="#">ICS</a></li>
                        <li><a data-select-type="CFS" href="#">CFS</a></li>
                    </ul>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default" id="report-bls-btn" title="BLS" onclick="scrollToRow('tr.bls-style');">
                        <span>BLS</span>
                    </button>
                    <button type="button" class="btn btn-default" id="report-ics-btn" title="ICS" onclick="scrollToRow('tr.ics-style');">
                        <span>ICS</span>
                    </button>
                    <button type="button" class="btn btn-default" id="report-cfs-btn" title="CFS" onclick="scrollToRow('tr.cfs-style');">
                        <span>CFS</span>
                    </button>
                </div> 
                <div class="btn-group btn-group-sm">
                     <button type="button" class="btn btn-danger" id="row-remove-btn" title="Trash">
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                    </button>
                </div>
            </div> <!-- <div id="report-ui"> -->

            <div id="report-content">
                <table class="table-hover">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Page #</th>
                            <th>Record Type</th>
                            <th>Row Content</th>
                        </tr>  
                    </thead>
                    <tbody>
                        {% for doc_row, page_no, page_row, content in report.rows %}
                            {% set record_name = report.rows_map.get(loop.index0, None) %}
                            {% if page_no in report.ics_pages %}
                                <tr class="ics-style" data-stm="ics" data-row-name="{{record_name}}">
                            {% elif page_no in report.bls_pages %}
                                <tr class="bls-style" data-stm="bls" data-row-name="{{record_name}}">
                            {% elif page_no in report.cfs_pages %}
                                <tr class="cfs-style" data-stm="cfs" data-row-name="{{record_name}}">
                            {% else %}
                                <tr data-stm="none" data-row-name="{{record_name}}">
                            {% endif %}
                                 <td class="selector">
                                    <a href="javascript:void(0);" class="recordform-btn"><span class="glyphicon glyphicon-plus"></span></a>
                                    <input type="checkbox">
                                </td>
                                <td class="pageno">{{page_no}}</td>
                                <td class="record-name">
                                    {% if record_name %}
                                        {% if page_no in report.ics_pages %}
                                            <a href="javascript:void(0);" onclick="activateTab('wrapper-ics'); focusOnRecord('*[data-record-name=\'{{record_name}}\']');">{{record_name}}</a>
                                        {% elif page_no in report.bls_pages %}
                                            <a href="javascript:void(0);" onclick="activateTab('wrapper-bls'); focusOnRecord('*[data-record-name=\'{{record_name}}\']');">{{record_name}}</a>
                                        {% elif page_no in report.cfs_pages %}
                                            <a href="javascript:void(0);" onclick="activateTab('wrapper-cfs'); focusOnRecord('*[data-record-name=\'{{record_name}}\']');">{{record_name}}</a>
                                        {% endif %}
                                    {% else %}
                                        <span>---</span>
                                    {% endif %}
                                </td>
                                <td class="content">{{content}}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container container-full">
        <h3>Identified Records</h3>
        <div>
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist" id="stm-wrappers">
                <li role="presentation" class="active"><a href="#wrapper-bls" aria-controls="wrapper-bls" role="tab" data-toggle="tab">BLS</a></li>
                <li role="presentation"><a href="#wrapper-ics" aria-controls="wrapper-ics" role="tab" data-toggle="tab">ICS</a></li>
                <li role="presentation"><a href="#wrapper-cfs" aria-controls="wrapper-cfs" role="tab" data-toggle="tab">CFS</a></li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="wrapper-bls">
                    <table id="bls-table" class="table table-hover records-table">
                        {% if report.bls|length == 0%}
                            <thead style="display: none;">
                        {% else %}
                            <thead>
                        {% endif %}
                            <tr>
                                <th></th>
                                <th></th>
                                <th>Record Type</th>
                                <th>Units</th>
                                {% for i in range(report.bls.ncols) %}
                                    {% if report.bls.names|length > i %}
                                        {% set timerange = report.bls.names[i][0] %}
                                        {% set timestamp = report.bls.names[i][1][:2]|join('-') %}
                                    {% else %}
                                        {% set timerange = '(not identified)' %}
                                        {% set timestamp = timerange %}
                                    {% endif %}
                                    <th data-column-id="{{loop.index}}">
                                        <span class="timerange">{{timerange}}</span> months ended on <span class="timestamp">{{timestamp}}</span>
                                        <a href="javascript:void(0);" class="time-editor-btn"><span class="glyphicon glyphicon-edit"></span></a>
                                        <a href="javascript:void(0);" onclick="removeColumn('#bls-table', {{loop.index}});" <span class="glyphicon glyphicon-remove"></span></a>
                                    </th>
                                {% endfor %}
                            </tr>  
                        </thead>
                        <tbody>
                            <tr class="empty-row" {% if report.bls|length > 0 %} style="display: none;" {% endif %}>
                                <td colspan="999">
                                    <div>
                                        <strong>No record has been identified.</strong>
                                    </div>
                                </td>
                            </tr>
                            {% for record_name, values in report.bls.items() %}
                                <tr class="record-row ui-widget-content" data-record-name="{{record_name}}">
                                    <td class="no-right-padding">
                                        <button type="button" class="btn btn-xs btn-danger record-remove-btn">
                                            <span class="glyphicon glyphicon-remove"></span>
                                        </button>     
                                    </td>
                                    <td class="no-left-padding"> 
                                        <button type="button" class="btn btn-xs btn-primary btn-to-row">
                                            <span class="glyphicon glyphicon-arrow-up"></span>
                                        </button>   
                                    </td>
                                    <td>
                                        <span class="record-rtype">{{record_name}}</span>
                                        <a href="javascript:void(0);" class="record-rtype-btn"><span class="glyphicon glyphicon-list"></span></a>
                                    </td>
                                    <td><select class="record-uom" data-init-val="{{report.bls.uom}}"></select></td>
                                    {% for value in values %}
                                        <td><input type="text" class="form-control input-sm" value="{{value}}"></td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button class="btn btn-primary" onclick="addEmptyRow('#bls-table', rtypes);">Add Record</button>
                    <button class="btn btn-primary" onclick="addEmptyColumn('#bls-table');">Add Column</button>
                </div>

                <div role="tabpanel" class="tab-pane" id="wrapper-ics">
                    <table id="ics-table" class="table table-hover records-table">
                        {% if report.ics|length == 0%}
                            <thead style="display: none;">
                        {% else %}
                            <thead>
                        {% endif %}
                            <tr>
                                <th></th>
                                <th></th>
                                <th>Record Type</th>
                                <th>Units</th>
                                {% for i in range(report.ics.ncols) %}
                                    {% if report.ics.names|length > i %}
                                        {% set timerange = report.ics.names[i][0] %}
                                        {% set timestamp = report.ics.names[i][1][:2]|join('-') %}
                                    {% else %}
                                        {% set timerange = '(not identified)' %}
                                        {% set timestamp = timerange %}
                                    {% endif %}
                                    <th data-column-id="{{loop.index}}">
                                        <span class="timerange">{{timerange}}</span> months ended on <span class="timestamp">{{timestamp}}</span>
                                        <a href="javascript:void(0);" class="time-editor-btn"><span class="glyphicon glyphicon-edit"></span></a>
                                        <a href="javascript:void(0);" onclick="removeColumn('#ics-table', {{loop.index}});" <span class="glyphicon glyphicon-remove"></span></a>
                                    </th>
                                {% endfor %}
                            </tr>  
                        </thead>
                        <tbody>
                            <tr class="empty-row" {% if report.ics|length > 0 %} style="display: none;" {% endif %}>
                                <td colspan="999">
                                    <div>
                                        <strong>No record has been identified.</strong>
                                    </div>
                                </td>
                            </tr>
                            {% for record_name, values in report.ics.items() %}
                                <tr class="record-row ui-widget-content" data-record-name="{{record_name}}">
                                    <td class="no-right-padding">
                                        <button type="button" class="btn btn-xs btn-danger record-remove-btn">
                                            <span class="glyphicon glyphicon-remove"></span>
                                        </button>      
                                    </td>
                                    <td class="no-left-padding">
                                        <button type="button" class="btn btn-xs btn-primary btn-to-row">
                                            <span class="glyphicon glyphicon-arrow-up"></span>
                                        </button>   
                                    </td>
                                    <td>
                                        <span class="record-rtype">{{record_name}}</span>
                                        <a href="javascript:void(0);" class="record-rtype-btn"><span class="glyphicon glyphicon-list"></span></a>
                                    </td>
                                    <td><select class="record-uom" data-init-val="{{report.ics.uom}}"></select></td>
                                    {% for value in values %}
                                        <td><input type="text" class="form-control input-sm" value="{{value}}"></td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button class="btn btn-primary" onclick="addEmptyRow('#ics-table', rtypes);">Add Record</button>
                    <button class="btn btn-primary" onclick="addEmptyColumn('#ics-table');">Add Column</button>
                </div>
                <div role="tabpanel" class="tab-pane" id="wrapper-cfs">
                    <table id="cfs-table" class="table table-hover records-table">
                        {% if report.cfs|length == 0%}
                            <thead style="display: none;">
                        {% else %}
                            <thead>
                        {% endif %}
                            <tr>
                                <th></th>
                                <th></th>
                                <th>Record Type</th>
                                <th>Units</th>
                                {% for i in range(report.cfs.ncols) %}
                                    {% if report.cfs.names|length > i %}
                                        {% set timerange = report.cfs.names[i][0] %}
                                        {% set timestamp = report.cfs.names[i][1][:2]|join('-') %}
                                    {% else %}
                                        {% set timerange = '(not identified)' %}
                                        {% set timestamp = timerange %}
                                    {% endif %}
                                    <th data-column-id="{{loop.index}}">
                                        <span class="timerange">{{timerange}}</span> months ended on <span class="timestamp">{{timestamp}}</span>
                                        <a href="#" data-toggle="modal" data-target="#column-editor"><span class="glyphicon glyphicon-edit"></span></a>
                                        <a href="javascript:void(0);" onclick="removeColumn('#cfs-table', {{loop.index}});" <span class="glyphicon glyphicon-remove"></span></a>
                                    </th>
                                {% endfor %}
                            </tr>  
                        </thead>
                        <tbody>
                            <tr class="empty-row" {% if report.cfs|length > 0 %} style="display: none;" {% endif %}>
                                <td colspan="999">
                                    <div>
                                        <strong>No record has been identified.</strong>
                                    </div>
                                </td>
                            </tr>
                            {% for record_name, values in report.cfs.items() %}
                                <tr class="record-row ui-widget-content" data-record-name="{{record_name}}">
                                    <td class="no-right-padding">
                                        <button type="button" class="btn btn-xs btn-danger record-remove-btn">
                                            <span class="glyphicon glyphicon-remove"></span>
                                        </button>      
                                    </td>
                                    <td class="no-left-padding">
                                        <button type="button" class="btn btn-xs btn-primary btn-to-row">
                                            <span class="glyphicon glyphicon-arrow-up"></span>
                                        </button>   
                                    </td>
                                    <td>
                                        <span class="record-rtype">{{record_name}}</span>
                                        <a href="javascript:void(0);" class="record-rtype-btn"><span class="glyphicon glyphicon-list"></span></a>
                                    </td>
                                    <td><select class="record-uom" data-init-val="{{report.cfs.uom}}"></select></td>
                                    {% for value in values %}
                                        <td><input type="text" class="form-control input-sm" value="{{value}}"></td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button class="btn btn-primary" onclick="addEmptyRow('#cfs-table', rtypes);">Add Record</button>
                    <button class="btn btn-primary" onclick="addEmptyColumn('#cfs-table');">Add Column</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container container-full">
        <div style="margin-top:30px"></div>
        {{ utils.render_export_form(url_for('dbmd_tools.upload_data')) }}
    </div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='vendors/jquery-ui/jquery-ui.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/select2/js/select2.full.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/bootstrap-datepicker/js/bootstrap-datepicker.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/bootstrap3-dialog/js/bootstrap-dialog.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/miner.js') }}"></script>
<script>
    var rtypes = {{ rtypes|tojson }};

    $("select.record-uom").bindUnitsOfMeasure();
    $("#company-select").applySelect2();
    
    // Remove comment if you want to make rows draggable.
    // $(".record-row").makeDraggable().makeDroppable();

    $(document).on("click", ".record-remove-btn", function() {
        var $table = $(this).closest("table");
        $(this).closest("tr").remove();
        toggleTable($table);
    });

    $(document).on("click", ".record-rtype-btn", function() {
        var $self = $(this);
        var recordId = getIDforRType($self.closest("td").find(".record-rtype").text(), rtypes);
        var dialog = createRTypeSelectionDialog({
            data: rtypes, text: "name", 
            initval: recordId,
            callback: function(rtype) {
                $self.closest("td").find(".record-rtype").text(rtype.text);
                $self.closest("tr").attr("data-record-name", rtype.text);

            }
        });
        dialog.open();
    });

    $(document).on("click", ".time-editor-btn", function() {
        var $timerange = $(this).parent().find(".timerange");
        var $timestamp = $(this).parent().find(".timestamp");
        var dialog = createTimeSelectionDialog({
            "timerange": $timerange,
            "timestamp": $timestamp
        });
        dialog.open();
    });

    activateFocusOnInputs("#ics-table");
    activateFocusOnInputs("#bls-table");
    activateFocusOnInputs("#cfs-table");

    // Seting animation when user clisk record in rows-table
    $("tr").on( // remove class from row to enable next animation
        "webkitAnimationEnd oanimationend msAnimationEnd animationend",
        function() {
            $(this).removeClass("backgroundAnimated");
        }
    );

    $(document).on("change", ".record-row select", function() {
        var recordType = $(this).find("option:selected").text();
        var $row = $(this).closest("tr");
        $row.attr("data-record-name", recordType);
    });

    $(document).on("click", ".btn-to-row", function() {
        var recordType = $(this).closest("tr").attr("data-record-name");
        focusOnRow("*[data-row-name='" + recordType + "']");
    });

    // Config form for adding new records
    $(document).on("click", ".recordform-btn", function() {
        var $currentRow = $(this).closest("tr");
        if (!$currentRow.next().hasClass("record-form")) {
            wrapWith("tr",
                wrapWith("td",
                    createRecordForm({
                        "rtypes": rtypes,
                        "abortCallback": function() {
                            $(this).closest("tr").remove();
                        },
                        "addCallback": function() {
                            var recordsData = readDataFromRecordForm($(this).closest("form"));
                            if (recordsData.type === "NONE") {
                                alert("No item selected. Please select one of the item from the list.");
                            } else {
                                var tableSelector = "#" + recordsData.statement.toLowerCase() + "-table";

                                var recordType = recordsData.type_name;
                                var numberOfColumns = getNumberOfColumns(tableSelector);
                                if (numberOfColumns < recordsData.values.length) {
                                    for(var i = 0; i < recordsData.values.length - numberOfColumns; i++) {
                                        addEmptyColumn(tableSelector);
                                    }
                                    numberOfColumns = recordsData.values.length;
                                }
                                var $newRow = createNewRecordRow(
                                    numberOfColumns, 
                                    {"data-record-name": recordType}
                                );
                                populateRowWithData($newRow, rtypes, recordsData);
                                addRowToTable($(tableSelector), $newRow);
                                bindRecordToRow($currentRow, recordType);
                                $(this).closest("tr").remove();
                            }
                        }
                    }),
                    {"colspan": "100%"}
                ),
                {"class": "record-form"}
            ).insertAfter($currentRow);
        }
    });

    // Setting report-ui
    $("#row-remove-btn").click(function() {
        $("#report-content").find(".selector input:checked").each(function() {
            $(this).closest("tr").remove();
        });
    });


    $(".selector > input").change(function() {
        refreshReportUI();
    });

    $('#stm-filter-list a, #stm-filter-btn').click(
        function () {
            var stype = $(this).data("select-type");
            if (stype !== undefined) {
                // Turn off all checkboxes.
                $(".selector > input:checkbox").prop("checked", false);
                switch(stype) {
                    case "ALL":
                        $(".selector > input:checkbox").prop("checked", true);
                        break;
                    case "NONE":
                        $(".selector > input:checkbox").prop("checked", false);
                        break;
                    case "BLS":
                        $("tr[data-stm='bls']").find(".selector > input").prop("checked", true);
                        break;
                    case "ICS":
                        $("tr[data-stm='ics']").find(".selector > input").prop("checked", true);
                        break;
                    case "CFS":
                        $("tr[data-stm='cfs']").find(".selector > input").prop("checked", true);
                        break;
                }
            }
            refreshReportUI();
        }
    );

    $(document).on("click", ".data-export-btn", function(event) {
        var data = createDataForExport(["#bls-table", "#ics-table", "#cfs-table"], rtypes);
        submitExportForm(data, validateData, function(result) {
            if (result) {
                $("#export-data-form").submit();
            }
        });
        event.preventDefault();
        return false;     
    });
    
    function activateTab(tab){
        $('.nav-tabs a[href="#' + tab + '"]').tab('show');
    };

    function validateData() {
        var val_bls = validateDataInTable($("#bls-table"), "Balance Sheet");
        var val_ics = validateDataInTable($("#ics-table"), "Income Statement");
        var val_cfs = validateDataInTable($("#cfs-table"), "Cash Flow Statement");
        var val_company = validateCompany();
        var val_report = validateReport();

        var result = [ val_bls, val_ics, val_cfs, val_company ].every(
            function(val) { return val.result; }
        );
        
        var alerts = [].concat(val_bls.alerts).concat(val_ics.alerts).concat(val_cfs.alerts);
        alerts.push(createAlertForCompanyValidation(val_company.details));
        alerts.push(createAlertForReportValidation(val_report.details));
        return {
            "result": result, 
            "alerts": alerts.filter(function(item) { 
                return item !== null && item !== undefined 
            })
        };
    }
</script>
{% endblock %}