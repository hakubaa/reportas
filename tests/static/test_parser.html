<!doctype html>
<html>
    <head>
        <title>Parser Test</title>
        <link rel="stylesheet" href="mocha.css">
    </head>

    <body>
        <div id="fixtures"></div>
        <div id="mocha"></div>

        <script src="jquery-1.7.1.min.js"></script>
        <script src="mocha.js"></script>
        <script src="chai.js"></script>
        <script src="sinon-1.17.6.js"></script>
        <script>mocha.setup("bdd");</script>

        <!-- load code you want to test heere -->
        <script src="../../app/static/js/parser.js"></script>

        <!-- load your test files here -->
        <script>

        var assert = chai.assert;

        function getJsonFromUrl(query) {
            var result = {};
            if (query !== null && query !== undefined) {
                query.split("&").forEach(function(part) {
                    var item = part.split("=");
                    result[item[0]] = decodeURIComponent(item[1]);
                });
            }
            return result;
        }

        describe("Identify Records Test", function() {

            describe("Sending Request", function() {

                var xhr = null;
                var requests = null;

                beforeEach(function() {
                    xhr = sinon.useFakeXMLHttpRequest();
                    requests = [];
                    xhr.onCreate = function(xhr) {
                        requests.push(xhr);
                    };
                });

                afterEach(function() {
                    xhr.restore();
                });

                it("test for sending post request", function() {
                    identifyItems({text: "NET PROFIT  100  200"});
                    assert.equal(requests.length, 1);
                });   

                it("test for using proper ulr", function() {
                    identifyItems({text: "NET PROFIT  100  200"});
                    assert.equal(requests[0].url, "/reports/parser");
                });

                it("test for passing text to request", function() {
                    identifyItems({text: "NET PROFIT  100  200"});
                    var params = getJsonFromUrl(requests[0].requestBody);
                    assert.equal(
                        params.text.replace(/\+/g, " "), 
                        "NET PROFIT  100  200"
                    );
                });

                it("test for passing spec to request", function() {
                    identifyItems({text: "NET PROFIT  100  200", spec: "BLS"});
                    var params = getJsonFromUrl(requests[0].requestBody);
                    assert.equal(params.spec, "BLS");
                });  

                it("test for raising exception when no text", function() {
                    chai.expect(function(){
                        identifyItems({spec: "BLS"});
                    }).to.throw("Undefined text.");
                });        
            });   

            describe("Handling Response", function() {
                var server = null;

                beforeEach(function () {
                    server = sinon.fakeServer.create();
                });

                afterEach(function () {
                    server.restore();
                });

                it("test for calling callback", function() {
                    server.respondWith("POST", "/reports/parser",
                        [
                            200, {
                            'Content-type': 'application/json'
                            }, ""
                        ]
                    );
                    var spy = sinon.spy();
                    identifyItems({text: "NET PROFIT  100  200", spec: "BLS", 
                                    callback: spy});
                    server.respond();
                    assert.isTrue(spy.called);
                });

            });              
           
        });
        </script>

        <script>
            mocha.run();
        </script>
    </body>

</html>